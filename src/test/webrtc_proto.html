<!DOCTYPE html>
<html>

<head>
    <title>Test</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://dooplns.github.io/localSocket/localSocket.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script>
        var rtcDataChannel;
        var rtcBuffer = "";
        var rtcBuffFlush = () => {
            rtcBuffer = ""
        };
        var rtcConnect = () => {};
        var rtcConnected = false

        async function main() {
            pyodide = await loadPyodide();
            pyodide.runPython(`
                from js import prompt
                __builtins__.input = prompt
            `);
            let code = await fetch("webrtc_proto.py").then(response => response.text());
            pyodide.runPython(code);
        }
        main().then(() => {
            var pc = new RTCPeerConnection();
            rtcConnect = () => init(rtcDataChannel = pc.createDataChannel("chat"));
            pc.ondatachannel = e => init(rtcDataChannel = e.channel);
            var init = rtcDataChannel => {
                rtcDataChannel.onopen = e => {
                    rtcConnected = true;
                    document.getElementById("con_status_btn").innerText = "Connected..."
                }
                rtcDataChannel.onclose = e => {
                    console.log("Bye!");
                    rtcConnected = false;
                    document.getElementById("con_status_btn").innerText = "Connect"
                }
                rtcDataChannel.onmessage = e => {
                    rtcBuffer = e.data;
                };
            };
            pc.oniceconnectionstatechange = e => console.log(pc.iceConnectionState);
            pc.onicecandidate = e => send({ candidate: e.candidate });
            pc.onnegotiationneeded = e => pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => send({ sdp: pc.localDescription }))
                .catch(console.log);
            var sc = new localSocket(), send = obj => sc.send(JSON.stringify(obj));
            var incoming = msg => msg.sdp &&
                pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))
                    .then(() => pc.signalingState == "stable" || pc.createAnswer()
                        .then(answer => pc.setLocalDescription(answer))
                        .then(() => send({ sdp: pc.localDescription })))
                    .catch(console.log) || msg.candidate &&
                pc.addIceCandidate(new RTCIceCandidate(msg.candidate)).catch(console.log);
            sc.onmessage = e => incoming(JSON.parse(e.data));
        });
    </script>
</head>

<body>
    <h1>Test</h1>
    <button id="con_status_btn" onclick="rtcConnect()">Connect</button>
    <p>Test</p>
    <button>Send!!!!!!</button>
</body>

</html>